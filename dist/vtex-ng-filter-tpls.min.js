/*! vtex-ng-filter - v0.3.1 - 2014-08-15 */
(function(){var config,moreOptionsShowFilters,openFilters,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};config={path:""},openFilters={},moreOptionsShowFilters={},angular.module("vtexNgFilter",["ui.bootstrap.accordion"]).factory("Filter",function($translate){var Filter;return Filter=function(){function Filter(filter){this.update=__bind(this.update,this),this.clearSelection=__bind(this.clearSelection,this),this.getSelectedItemsURL=__bind(this.getSelectedItemsURL,this),this.getSelectedItems=__bind(this.getSelectedItems,this),this.setSelectedItems=__bind(this.setSelectedItems,this),this.updateSelectedCount=__bind(this.updateSelectedCount,this);var k,v;for(k in filter)v=filter[k],this[k]=v;this.selectedCount=0,"date"===this.type&&(this.dateObjectCache={},this.date={},this.today=moment().endOf("day").toDate(),this.setDates=function(_this){return function(offsetFrom,offsetTo){var date;return null==offsetFrom&&(offsetFrom=0),null==offsetTo&&(offsetTo=0),date={from:moment().add("d",offsetFrom).startOf("day").toDate(),to:moment().add("d",offsetTo).endOf("day").toDate()},_this.date=date}}(this),this.dateRangeLabel=function(_this){return function(){return _this.date.from&&_this.date.to?moment(_this.date.from).startOf("day").isSame(moment().startOf("day"))?$translate("listing.dates.today"):moment(_this.date.from).isSame(moment().add("d",-1).startOf("day"))&&moment(_this.date.to).isSame(moment().add("d",-1).endOf("day"))?$translate("listing.dates.yesterday"):moment(_this.date.to).startOf("day").isSame(moment().startOf("day"))?""+moment(_this.date.from).add("hours",moment().hours()).fromNow()+" "+$translate("listing.dates.untilToday"):""+moment(_this.date.from).add("hours",moment().hours()).fromNow()+" "+$translate("listing.dates.until")+" "+moment(_this.date.to).add("hours",moment().hours()).fromNow():$translate("listing.dates.noRangeSelected")}}(this)),this.updateSelectedCount()}return Filter.prototype.updateSelectedCount=function(){var i,item,lastSelectedItemIndex,selectedItemIndex,_i,_j,_len,_len1,_ref,_ref1;if("date"===this.type)this.selectedCount=this.date.from&&this.date.to?1:0;else if("multiple"===this.type){for(_ref=this.items,i=_i=0,_len=_ref.length;_len>_i;i=++_i)item=_ref[i],item.selected&&(lastSelectedItemIndex=i);lastSelectedItemIndex>4&&(moreOptionsShowFilters[this.rangeUrlTemplate]=!0),this.selectedCount=_.filter(this.items,function(i){return i.selected}).length}else if("single"===this.type){for(_ref1=this.items,i=_j=0,_len1=_ref1.length;_len1>_j;i=++_j)item=_ref1[i],item===this.selectedItem&&(selectedItemIndex=i);selectedItemIndex>4&&(moreOptionsShowFilters[this.rangeUrlTemplate]=!0),this.selectedCount=this.selectedItem?1:0}return this.selectedCount>0&&(openFilters[this.rangeUrlTemplate]=!0),this.selectedCountLabel=this.selectedCount?"("+this.selectedCount+")":""},Filter.prototype.setSelectedItems=function(itemsAsSearchParameter){var date,item,items,_i,_len,_ref,_ref1;if("date"===this.type)items=itemsAsSearchParameter.replace(this.name+":[","").replace("]","").split(" TO "),date={from:new Date(items[0]),to:new Date(items[1])},this.date=date;else if("multiple"===this.type)for(_ref=this.items,_i=0,_len=_ref.length;_len>_i;_i++)item=_ref[_i],item.selected=(_ref1=item.url,__indexOf.call(itemsAsSearchParameter.split(","),_ref1)>=0);else"single"===this.type&&(this.selectedItem=_.find(this.items,function(i){return i.url===itemsAsSearchParameter}));return this.updateSelectedCount()},Filter.prototype.getSelectedItems=function(){var item,url,_base,_i,_len,_ref,_results;if("date"===this.type)return this.date.from&&this.date.to?(url=""+this.name+":["+moment(this.date.from).startOf("day").toISOString()+" TO "+moment(this.date.to).endOf("day").toISOString()+"]",(_base=this.dateObjectCache)[url]||(_base[url]={name:this.dateRangeLabel(),url:url}),[this.dateObjectCache[url]]):[];if("multiple"===this.type){for(_ref=this.items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)item=_ref[_i],item.selected&&_results.push(item);return _results}return"single"===this.type?this.selectedItem?[this.selectedItem]:[]:void 0},Filter.prototype.getSelectedItemsURL=function(){var selectedArray;return selectedArray=_.map(this.getSelectedItems(),function(i){return i.url}),selectedArray.length>0?selectedArray.join(","):null},Filter.prototype.clearItem=function(itemObject){var item,_i,_len,_ref,_ref1;if("date"===(_ref=this.type)||"single"===_ref)return this.clearSelection();if("multiple"===this.type){for(_ref1=this.items,_i=0,_len=_ref1.length;_len>_i;_i++)item=_ref1[_i],itemObject.url===item.url&&(item.selected=!1);return this.updateSelectedCount()}},Filter.prototype.clearSelection=function(){var item,_i,_len,_ref;if("date"===this.type)this.date={};else if("multiple"===this.type)for(_ref=this.items,_i=0,_len=_ref.length;_len>_i;_i++)item=_ref[_i],item.selected=!1;else"single"===this.type&&(this.selectedItem=null);return this.updateSelectedCount()},Filter.prototype.update=function(filterJSON){var item,updatedItem,_i,_len,_ref,_ref1,_results;for(null==filterJSON&&(filterJSON=this),_ref=this.items,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)item=_ref[_i],updatedItem=_.find(filterJSON.items,function(i){return i.name===item.name}),_results.push(updatedItem&&0===(null!=(_ref1=this.getSelectedItems())?_ref1.length:void 0)?item.quantity=updatedItem.quantity:item.quantity=0);return _results},Filter}()}).directive("vtFilter",function($location){return{restrict:"E",scope:{filters:"=filters"},templateUrl:config.path?config.path+"/vtex-ng-filter.html":"vtex-ng-filter.html",link:function($scope){var filter,filters,updateFiltersOnLocationSearch,_i,_len;for(filters=$scope.filters,_i=0,_len=filters.length;_len>_i;_i++)filter=filters[_i],openFilters.hasOwnProperty(filter.rangeUrlTemplate)||(openFilters[filter.rangeUrlTemplate]=!1),moreOptionsShowFilters.hasOwnProperty(filter.rangeUrlTemplate)||(moreOptionsShowFilters[filter.rangeUrlTemplate]=!1);return $scope.openFilters=openFilters,$scope.moreOptionsShowFilters=moreOptionsShowFilters,$scope.clearAll=function(){var _j,_len1,_results;for(_results=[],_j=0,_len1=filters.length;_len1>_j;_j++)filter=filters[_j],_results.push(filter.clearSelection());return _results},filters.getAppliedFilters=function(){return _.filter(filters,function(f){return f.getSelectedItems().length>0})},filters.getAppliedItems=function(){return _.chain(filters.getAppliedFilters()).map(function(f){return f.getSelectedItems()}).flatten().value()},updateFiltersOnLocationSearch=function(){var searchQuery,_j,_len1,_results;for(_results=[],_j=0,_len1=filters.length;_len1>_j;_j++)filter=filters[_j],searchQuery=$location.search()[filter.rangeUrlTemplate],searchQuery?(filter.setSelectedItems(searchQuery),_results.push(filter.update())):_results.push(void 0);return _results},updateFiltersOnLocationSearch(),$scope.$on("$locationChangeSuccess",function(){var queryFilters,selectedFilters;return queryFilters=_.map(filters,function(f){return $location.search()[f.rangeUrlTemplate]}).join(),selectedFilters=_.map(filters,function(f){return f.getSelectedItemsURL()}).join(),queryFilters!==selectedFilters?updateFiltersOnLocationSearch():void 0}),_.each(filters,function(filter,i){return $scope.$watch(function(scope){return scope.filters[i].getSelectedItemsURL()},function(newValue,oldValue){var _j,_len1;if(newValue!==oldValue){for(_j=0,_len1=filters.length;_len1>_j;_j++)filter=filters[_j],$location.search(filter.rangeUrlTemplate,filter.getSelectedItemsURL());return $location.search("page",1)}})})}}}).directive("vtFilterSummary",function(){return{restrict:"E",scope:{filters:"=filters"},templateUrl:config.path?config.path+"/vtex-ng-filter-summary.html":"vtex-ng-filter-summary.html"}}).directive("vtFilterButton",function(){return{restrict:"E",scope:{filters:"=filters",openFilters:"&"},templateUrl:config.path?config.path+"/vtex-ng-filter-button.html":"vtex-ng-filter-button.html",link:function(){}}}).provider("vtexNgFilter",{config:config,$get:function(filter){return filter}})}).call(this),angular.module("vtexNgFilter").run(function($templateCache){"use strict";$templateCache.put("vtex-ng-filter-button.html",'<button type="button" class="btn btn-default filter-inner-btn pull-left"><i class="fa fa-filter fa-sm"></i> <span class="badge badge-info badge-corner" ng-show="filters.getAppliedItems().length > 0">{{ filters.getAppliedItems().length }}</span></button>'),$templateCache.put("vtex-ng-filter-summary.html",'<div class="filters-summary"><small ng-show="filters.length > 0" ng-repeat="filter in filters.getAppliedFilters()"><span ng-repeat="item in filter.getSelectedItems()"><span class="label label-info"><span>{{item.name}}</span>&nbsp; <a href="javascript:void(0);" ng-click="filter.clearItem(item)"><i class="icon-remove-sign"></i></a></span>&nbsp;</span></small></div>'),$templateCache.put("vtex-ng-filter.html",'<div class="filters-block"><h3><span translate="">listing.filters</span> <button translate="" class="btn btn-small btn-clean-filters" ng-click="clearAll()">listing.clearAll</button></h3><accordion close-others="true"><accordion-group is-open="openFilters[filter.rangeUrlTemplate]" heading="{{ \'filters.\' + filter.rangeUrlTemplate | translate }} {{ filter.selectedCountLabel }}" ng-repeat="filter in filters"><div ng-switch="" on="filter.type"><div ng-switch-when="date"><p><a href="javascript: void(0)" ng-click="filter.setDates()" translate="">listing.dates.today</a></p><p><a href="javascript: void(0)" ng-click="filter.setDates(-1, -1)" translate="">listing.dates.yesterday</a></p><p><a href="javascript: void(0)" ng-click="filter.setDates(-7)" translate="">listing.dates.thisWeek</a></p><p><a href="javascript: void(0)" ng-click="filter.setDates(-30)" translate="">listing.dates.thisMonth</a></p><p><a href="javascript: void(0)" ng-click="filter.clearSelection()" translate="">listing.dates.clearFilter</a></p><div class="input-append"><input type="text" ng-click="openFilters[filter.rangeUrlTemplate + \'Selector\'] = !openFilters[filter.rangeUrlTemplate + \'Selector\']" value="{{filter.dateRangeLabel()}}" readonly><a href="javascript:void(0);" class="add-on" ng-click="openFilters[filter.rangeUrlTemplate + \'Selector\'] = !openFilters[filter.rangeUrlTemplate + \'Selector\']"><i class="icon-calendar"></i></a></div><div class="date-selectors" ng-show="openFilters[filter.rangeUrlTemplate + \'Selector\']"><div class="controls"><p translate="">listing.dates.from</p><div class="well well-small pull-left" ng-model="filter.date.from"><datepicker show-weeks="false" max="filter.date.to ? filter.date.to : filter.today"></datepicker></div></div><div class="controls"><p translate="">listing.dates.to</p><div class="well well-small pull-left" ng-model="filter.date.to"><datepicker show-weeks="false" min="filter.date.from" max="filter.today"></datepicker></div></div></div></div><div ng-switch-default=""><ul class="filter-list nav nav-pills nav-stacked"><!-- If 5 items, show all 5.\n                             If 6 items, show all 6.\n                             If 7 items, show 5 and button to show more. --><li ng-repeat="item in filter.items" ng-show="(filter.items.length <= 6) || ($index < 5) || moreOptionsShowFilters[filter.rangeUrlTemplate]"><label class="checkbox" ng-if="filter.type == \'multiple\'"><input type="checkbox" name="{{filter.name}}" ng-model="item.selected" ng-change="filter.updateSelectedCount()"><span>{{ item.name }} {{ item.quantity ? \'(\' + item.quantity + \')\' : \'\' }}</span></label><label class="radio" ng-if="filter.type == \'single\'"><input type="radio" name="{{filter.name}}" ng-model="filter.selectedItem" ng-value="item"><span>{{ item.name }} {{ item.quantity ? \'(\' + item.quantity + \')\' : \'\' }}</span></label></li></ul><a href="javascript:void(0)" ng-click="moreOptionsShowFilters[filter.rangeUrlTemplate] = true" ng-show="filter.items.length > 6 && !moreOptionsShowFilters[filter.rangeUrlTemplate]" class="muted">{{ \'filters.moreOptionsShow\' | translate}} ({{ filter.items.length }})</a> <a href="javascript:void(0)" ng-click="moreOptionsShowFilters[filter.rangeUrlTemplate] = false" ng-show="filter.items.length > 6 && moreOptionsShowFilters[filter.rangeUrlTemplate]" class="muted">{{ \'filters.moreOptionsHide\' | translate}}</a> <button translate="" class="btn" ng-click="filter.clearSelection()" ng-show="filter.type === \'single\' && filter.selectedItem">search.clear</button></div></div></accordion-group></accordion></div>')});